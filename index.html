<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Responsive Weather App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/main.min.css">
    <link rel="stylesheet" href="css/login.css">
    <script src="https://smtpjs.com/v3/smtp.js"></script>
    <script src="js/main.js" type="module"></script>
</head>
<body>
    <main class="fade-in">
        <h1 class="offscreen">Responsive Weather App Powered by the Open Weather A P I</h1>
        <section id="searchBar" class="searchBar fade-in">
            <form id="searchBar__form" class="searchBar__form" role="search">
                <label for="searchBar__text" class="offscreen">Enter a new location</label>
                <input id="searchBar__text" class="searchBar__text" type="text" role="searchbox" size="40" autocomplete="off" placeholder="City, State, Country">
                <button id="searchBar__button" class="searchBar__button button" title="Submit Location" aria-label="Submit Search">
                    <i class="fa fa-search"></i>
                    <i class="fas fa-sync fa-spin none"></i>
                </button>
            </form>
        </section>
        <a href="#currentForecast" class="skip-link">Skip to Current Conditions</a>
        <section id="currentForecast" class="currentForecast fade-in" role="region" aria-labelledby="currentForecast__location">
          <h2 id="currentForecast__location" class="currentForecast__location">Current Conditions</h2>
          <div id="currentForecast__conditions" class="currentForecast__conditions"></div>
        </section>
        <a href="#dailyForecast" class="skip-link">Skip to Six Day Forecast</a>
        <nav id="navButtons" class="navButtons fade-in">
            <button id="getLocation" class="button" title="Get Location" aria-label="Get the current weather conditions for your current location">
                <i class="fas fa-map-marker-alt"></i>
                <i class="fas fa-sync fa-spin none"></i>
            </button>
            <button id="home" class="button" title="Home weather" aria-label="Get the current weather conditions for your home location">
                <i class="fas fa-home"></i>
                <i class="fas fa-sync fa-spin none"></i>
            </button>
            <button id="saveLocation" class="button" title="Save Location" aria-label="Save the current location as your home location">
                <i class="fas fa-save"></i>
                <i class="fas fa-sync fa-spin none"></i>
            </button>
            <button id="unit" class="button" title="Toggle Measurement Units" aria-label="Toggle between metric and imperial measurement units">
                <i class="fas fa-chart-bar"></i>
                <i class="fas fa-sync fa-spin none"></i>
            </button>
            <button id="refresh" class="button" title="Refresh Weather" aria-label="Refresh the current weather conditions">
                <i class="fas fa-sync-alt"></i>
                <i class="fas fa-sync fa-spin none"></i>
            </button>
        </nav>
        <hr class="fade-in">
        <section id="dailyForecast" class="dailyForecast fade-in" role="region" aria-labelledby="dailyForecast__title">
            <h2 id="dailyForecast__title" class="dailyForecast__title offscreen">Six Day Forecast</h2>
            <div id="dailyForecast__contents" class="dailyForecast__contents"></div>
        </section>
        <p id="confirmation" class="offscreen" aria-live="assertive"></p>
    </main>

    <div id="id01" class="modal" style="display: hidden;">
        <div id="loginSec" class="modal-content animate">
            <div class="container" style="color: black; text-align: center;">
                <h3 style="text-align: center; margin-top: 25px;">Please Login To Continue</h3>

                <input id="logEmailId" type="text" style="margin-top: 50px;" placeholder="Enter Email Address" required>
                <input id="logPasswordId" type="password"  style="margin-top: 25px; margin-bottom: 50px;" placeholder="Enter Password" required>
                
                <button id="loginBtn">Login</button>
                
                <div style="background-color: red;"><label id="errMsg" style="display: none;"></label></div>
                <p style="margin-top: 25px;">Are you not registerd yet ???</p>

                <button style="margin-top: 25px; background-color: deepskyblue;" id="registerBtn">Registration</button>
            </div>
        </div>
        <div id="registerSec" class="modal-content animate" style="display: none;">
            <div class="container" style="color: black; text-align: center;">
                <h3 style="text-align: center; margin-top: 25px;">Registration</h3>

                <input id="registerEmailId" type="text" style="margin-top: 50px;" placeholder="Enter Email Address" required>
                <input id="registerPasswordId" type="password"  style="margin-top: 25px;" placeholder="Enter Password" required>
                <input id="confPassId" type="password"  style="margin-top: 25px;" placeholder="Confirm Password" required>
                
                <button style="background-color: deepskyblue;" id="registerSecBtn">Registration</button>
                
                <div style="background-color: red;"><label id="errMsgReg" style="display: none;"></label></div>
            </div>
        </div>
    </div>

    <script>
        // Get the modal
        let modal = document.getElementById('id01');
        
        window.onload = () => {
            modal.style.display = "block";

            let loginBtn = document.getElementById('loginBtn');
            let registerBtn = document.getElementById('registerBtn');

            loginBtn.addEventListener('click', () => {
                let usr = document.getElementById('logEmailId').value;
                let psw = document.getElementById('logPasswordId').value;

                let xmlhttp = new XMLHttpRequest();
            
                xmlhttp.onreadystatechange = function() {
                    if (this.responseText === "success") {
                        modal.style.display = "none";
                        localStorage.setItem("emailWAPP", usr);

                        let xmlhttp = new XMLHttpRequest();
                        xmlhttp.open("GET","api/getLocation.php?usr="+usr,true);
                        xmlhttp.send();
                        xmlhttp.onload = function () {
                            let locArr = JSON.parse(xmlhttp.responseText);
                            localStorage.setItem("defaultWeatherLocation", JSON.stringify(locArr[0]));
                            dispatchEvent(new Event('locationchanged'));
                        }
                    } else {
                        let errorMsg = document.getElementById('errMsg');
                        errorMsg.style = "display: block; color: black; margin-top: 25px;";
                        errorMsg.innerHTML = "Please Enter Correct Login Details";
                    }
                };

                xmlhttp.open("GET","api/login.php?user="+usr+"&&password="+psw,true);
                xmlhttp.send();
            });

            registerBtn.addEventListener('click', () => {
                let regSec = document.getElementById('registerSec');
                let loginSec = document.getElementById('loginSec');
                loginSec.style = "display: none";
                regSec.style = "display: block";
            });

            let registerSecBtn = document.getElementById('registerSecBtn');

            registerSecBtn.addEventListener('click', () => {
                let usr = document.getElementById('registerEmailId').value;
                let psw = document.getElementById('registerPasswordId').value;
                let confirmPsw = document.getElementById('confPassId').value;

                if (usr === '' || psw === '' || confirmPsw === '') {
                    let errorMsg = document.getElementById('errMsgReg');
                    errorMsg.style = "display: block; color: black; margin-top: 25px;";
                    errorMsg.innerHTML = "One of the field is empty!!!";
                } else if (psw !== confirmPsw) {
                    let errorMsg = document.getElementById('errMsgReg');
                    errorMsg.style = "display: block; color: black; margin-top: 25px;";
                    errorMsg.innerHTML = "Please enter the same password in confirm password!!!";
                } else {
                    let xmlhttp = new XMLHttpRequest();

                    let usrObj = {
                        email: usr,
                        password: psw
                    };

                    let post = JSON.stringify(usrObj);

                    xmlhttp.open("POST","api/registration.php",true);
                    xmlhttp.setRequestHeader('Content-type', 'application/json; charset=UTF-8')
                    xmlhttp.send(post);

                    xmlhttp.onload = function () {
                        if(xmlhttp.responseText === "success") {
                            alert("Registration successful !!!, Please login to continue");

                            let regSec = document.getElementById('registerSec');
                            let loginSec = document.getElementById('loginSec');
                            loginSec.style = "display: block";
                            regSec.style = "display: none"; 
                        } else {
                            let errorMsg = document.getElementById('errMsgReg');
                            errorMsg.style = "display: block; color: black; margin-top: 25px;";
                            errorMsg.innerHTML = xmlhttp.responseText;
                        }
                    }
                }
            });
        } 
        </script>
</body>
</html>